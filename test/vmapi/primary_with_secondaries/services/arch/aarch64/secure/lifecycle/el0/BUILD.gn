# Copyright 2025 The Hafnium Authors.
#
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file or at
# https://opensource.org/licenses/BSD-3-Clause.

import("//build/image/image.gni")
import("//test/hftest/args.gni")

source_set("abort_el0_sp") {
  testonly = true
  public_configs = [
    "//test/vmapi/primary_with_secondaries/services/arch/aarch64/secure:config",
    "//test/hftest:hftest_config",
    "//src/arch/aarch64:arch_config",
  ]
  sources = [ "abort_secure_interrupts.c" ]
  deps = [ "//test/vmapi/common:ffa" ]
}

vm_kernel("sp_lifecycle_service_el0") {
  testonly = true

  deps = [
    "//src/arch/aarch64/hftest/el0:interrupts",
    "//src/arch/aarch64/hftest/el0:mm",
    "//test/hftest:hftest_sel0_partition_base",
    "//test/vmapi/common/arch/aarch64/el0:exception_handler",
    "//test/vmapi/primary_with_secondaries:primary_with_secondaries",
    "//test/vmapi/primary_with_secondaries/services:echo",
    "//test/vmapi/primary_with_secondaries/services:ffa_check",
    "//test/vmapi/primary_with_secondaries/services:memory",
    "//test/vmapi/primary_with_secondaries/services:relay",
    "//test/vmapi/primary_with_secondaries/services:rx_ownership",
    "//test/vmapi/primary_with_secondaries/services/arch/aarch64/el0:mem_permissions",
    "//test/vmapi/primary_with_secondaries/services/arch/aarch64/secure:common",
    "//test/vmapi/primary_with_secondaries/services/arch/aarch64/secure:message_loop",
    "//test/vmapi/primary_with_secondaries/services/arch/aarch64/secure/el0:secure_interrupts",
    "//test/vmapi/primary_with_secondaries/services/arch/aarch64/secure/lifecycle:abort_common",
  ]
}

manifest("sp1_pm_lifecycle") {
  source = "sp1_pm_lifecycle.dts"
  output = "sp1_pm_lifecycle.dtb"
}

manifest("sp4_pm_lifecycle") {
  source = "sp4_pm_lifecycle.dts"
  output = "sp4_pm_lifecycle.dtb"
}

partition_package("service_sp1_partition_pkg") {
  testonly = true
  pm_offset = "0x1000"
  img_offset = "0x2000"
  files = [ [
        "sp1_pm_lifecycle.dtb",
        "sp_lifecycle_service_el0.bin",
        ":sp1_pm_lifecycle",
        ":sp_lifecycle_service_el0",
      ] ]
  output = "service_sp1_partition_pkg.img"
}

partition_package("service_sp4_partition_pkg") {
  testonly = true
  pm_offset = "0x1000"
  img_offset = "0x2000"
  files = [ [
        "sp4_pm_lifecycle.dtb",
        "sp_lifecycle_service_el0.bin",
        ":sp4_pm_lifecycle",
        ":sp_lifecycle_service_el0",
      ] ]
  output = "service_sp4_partition_pkg.img"
}
